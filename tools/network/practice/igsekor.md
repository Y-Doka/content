---
tags:
  - practice
permalink: false
---

## Мониторинг сети

### Обзор сетевых устройств

Если компьютер имеет подключённый к сети сетевой интерфейс или несколько интерфейсов, то в первую очередь необходимо получить их список. Это можно сделать через графический интерфейс или с помощью терминала:

- `ifconfig` — для Unix-подобных операционных систем;
- `ipconfig /all` — для операционной системы Windows.

В списке сетевых интерфейсов можно будет посмотреть и IP-адреса, к которым они будут привязаны.

С помощью консольной утилиты `ping`, как правило, можно получить информацию о том, присутствует ли сетевое устройство в сети или нет. Например, проверить доступность известного прокси-сервера от Google можно так:

```bash
ping 8.8.8.8
```

### Мониторинг соединений

Существует масса утилит для мониторинга соединений, которые собирают и отображают информацию об открытых соединениях, портах и приложениях, которые используют эти соединения. Среди прочих утилита `netstat` присутствует практически в любой операционной системе. Например, эта утилита есть в Windows, на MacOS или в Linux. В Linux эта утилита не всегда предустановлена, но поставляет с составе пакета [net-tools](https://wiki.linuxfoundation.org/networking/net-tools).

Чтобы просмотреть все соединения, которые работаю в настоящее время, необходимо в Терминале выполнить команду:

```bash
netstat
```

Для фильтрации списка соединений необходимо использовать ключи. Например, для анализа активных сетевых соединений, использующих определённые протоколы, надо использовать ключ `-p`. Например, для анализа соединений, работающих по протоколу TCP:

```bash
netstat -p tcp
```

Если воспользоваться ключом `-n`, то можно вывести все IP-адреса с указанием портов для каждого приложения на компьютере, которое использует сетевой интерфейс:

```bash
netstat -n
```

Для анализа безопасности компьютера важно знать, какие существуют входящие соединения. Это  возможно с помощью ключа `-L`:

```bash
netstat -L
```

Если воспользоваться ключом `-s`, можно вывести статистику по протоколам:

```bash
netstat -s
```

Ключ `-i` позволяет посмотреть доступные сетевые интерфейсы:

```bash
netstat -i
```

Перед использованием утилиты, изучите руководство с помощью команды:

```bash
man netstat
```

Использование команды `man` подробно описано в статье «[Интерфейс командной строки](/tools/articles/cli)».

Операционная система Linux постоянно обновляется, обновляются и утилиты. Например, вместо `netstat` лучше использовать `ss`, а вместо `ifconfig` — утилиту `ip`.

<details>
  <summary>Подробности...</summary>

  Старые команды         | Новые команды           | Применение
  :----------------------|:------------------------|:------------------------------------------------------
  `ifconfig -a`          |`ip a`                   | Вывод списка всех IP-адресов всех сетевых интерфейсов
  `ifconfig enp6s0 down` |`ip link set enp6s0 down`| Выключить сетевой интерфейс
  `ifconfig enp6s0 up`   |`ip link set enp6s0 up`  | Включить сетевой интерфейс
  `netstat`              |`ss`                     | Вывод всех активных соединений
  `netstat <keys>`       |`ss <keys>`              | Ключи у команд практически совпадают, подробнее: `man ss`
</details>

### Мониторинг пакетов

Существуют специальные утилиты, которые позволяют просматривать пакеты в сетевом трафике. В Linux и большинстве Unix-подобных систем есть консольная утилита `tcpdump`, есть и кросс-платформенная утилита Wireshark с графическим интерфейсом. Эти две утилиты в основном и используются для мониторинга пакетов.

#### Wireshark

Утилиту Wireshark можно [скачать](https://www.wireshark.org/#download) и установить с официального сайта. Она опенсорсная и имеет графический интерфейс, который состоит из трёх частей (сверху вниз):

- список пакетов, пересылаемых по сети;
- пакет, представленный в текстовом виде;
- пакет, представленный в бинарном виде.

![Рабочее окно утилиты Wireshark](images/3.png)

Вы можете получить подробную информацию о каждом пакете, нужно лишь выбрать его из списка. Пакеты можно фильтровать по различным признакам. Существуют фильтры захвата и показа. Первый тип фильтров используется для захвата пакетов в реальном времени, сбора информации и статистики по ним. Фильтры показа (дисплейные фильтры) позволяют оперировать с уже захваченными пакетами. Захват пакетов с выбранного сетевого интерфейса осуществляется с момента нажатия кнопки «Начать захват пакетов» (Start capturing packets) и до нажатия кнопки «Остановить захват пакетов» (Stop capturing packets). Захват пакетов — это сбор информации о пакетах.

В Wireshark есть предустановленные фильтры, но можно формировать и собственные с помощью мастера или вручную в строке фильтрации в самом верху окна. Утилита Wireshark поможет веб-разработчику детально разобраться с пакетами, которые отправляются серверу или приходят от сервера. Если [веб-сервер](/tools/articles/webserver) установлен на компьютере с Wireshark, можно посмотреть, как пользователи работают с сайтом.

Мониторинг пакетов также может помочь выявить аномальный трафик и проанализировать безопасность компьютера с точки зрения его работы с сетью. Данные можно сохранять в текстовый файл для последующего анализа в Wireshark или любым другим способом.

#### `tcpdump`

Если графический интерфейс не доступен, например, вы настраиваете удалённый сервер, можно использовать `tcpdump`. Чтобы просмотреть трафик, надо набрать команду:

```bash
tcpdump
```

Не забывайте, что на некоторых операционных системах, утилиту необходимо запускать от имени администратора.

Пока вы не прервете работу утилиты сигналом `SIGINT`, нажав сочетание клавиш <kbd>Ctrl C</kbd>, в терминал будет выводиться информация о пакетах. Прочитайте статью [«Управление процессами»](/tools/articles/process-management), чтобы узнать больше о сигналах. Как работать с терминалом описано в статье «[Интерфейс командной строки](/tools/articles/cli)».

Пакеты можно фильтровать. Например, чтобы вывести пакеты, которые приходят на 80-й порт по протоколам транспортного уровня TCP или UDP, нужно выполнить команду:

```bash
tcpdump udp port 80 or tcp port 80
```

Информацию можно выводить в файл, а не в терминал. Для этого нужно указать соответствующий ключ:

```bash
tcpdump -w out.pcap
```

Чтобы прочитать этот файл, можно использовать Wireshark, который поддерживает данные в формате `.pcap`, или тот же `tcpdump`:

```bash
tcpdump -r out.pcap
```

## Настройка сетевых служб

### Управление брандмауэром, фильтрация пакетов

Для обеспечения безопасности в сети используют брандмауэр. Эта программа, которая позволяет фильтровать входящие и исходящие пакеты, которые проходят через определённый порт с учётом IP-адреса. В Unix-подобных системах используются утилиты типа `iptables` или `nftables` для анализа трафика и перенаправления его. Поскольку Unix-подобные системы являются сетевыми, сама фильтрация пакетов осуществляется на уровне ядра системы, утилиты позволяют лишь поработать с настройкой фильтрации.

В настройках описываются правила фильтрации пакетов, которые применяются по цепочке. существуют правила для входящих, исходящих и транзитных пакетов. Рассмотрим простой пример: запрет приёма пакетов, которые приходят по протоколу [ICMP](https://ru.wikipedia.org/wiki/ICMP). Это не позволит воспользоваться утилитой `ping` для того, чтобы обнаружить компьютер в сети. Реализовать данное правило можно очень просто:

```bash
iptables -A INPUT -p icmp --icmp-type echo-request - j REJECT
```

Ключ `-A` означает, что необходимо добавить правило в конец цепочки правил `INPUT`, которые обрабатывают входящие пакеты. По ключу `-p` можно задать протокол, у нас это ICMP. `--icmp-type` — специальный ключ для этого протокола, который определяет тип пакетов для этого протокола. `-j` определяет действие, у нас это — отклонить. То есть входящие пакеты по протоколу ICMP типа `echo-request` необходимо отклонить.

Чтобы посмотреть все правила выполняем команду:

```bash
iptables -L
```
